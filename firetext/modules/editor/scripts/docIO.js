function initDocIO(c,g,u){function p(){var a=c.doctype;return(a?"<!DOCTYPE "+a.name+(a.publicId?' PUBLIC "'+a.publicId+'"':"")+(!a.publicId&&a.systemId?" SYSTEM":"")+(a.systemId?' "'+a.systemId+'"':"")+">":"")+c.documentElement.outerHTML.replace(/<([a-z]+)[^>]*_firetext_remove=""[^>]*>[^<>]*(?:<\/\1>)?/g,"").replace(/ _firetext_[a-z_]+=""/g,"").replace(/ contenteditable="(?:true|false)"/g,"").replace(/<p[^>]+collab-added=""[^>]+><br><\/p>(<\/body>)/,"$1").replace(/ collab[-a-z]*="[a-z\d.]*"/g,"").replace(/ spellcheck="(?:true|false)"/,
"")}function r(){var a=p(),a=a.replace("<html","<html moznomarginboxes").replace("</head>",["\x3c!--_firetext_import_remove_start--\x3e","\t<title>"+t.replace(/</g,"&lt;")+"</title>",'\t<meta name="viewport" content="width=device-width">\n\t<style>\n\thtml {\n\t\twidth: var(--width);\n\t\tmax-width: none !important; /* Older documents have style="max-width: 690px" */\n\t\toverflow-x: hidden;\n\t}\n\tbody {\n\t\tpadding: var(--margin);\n\t\tmargin: 0;\n\t\tword-wrap: break-word;\n\t\toverflow-x: hidden;\n\t}\n\thr.page-break {\n\t\tborder: none;\n\t}\n\t@media screen {\n\t\thtml {\n\t\t\tpadding: 65px 0;\n\t\t\tbackground-color: #efefef;\n\t\t}\n\t\tbody {\n\t\t\tborder: 1px solid #ddd;\n\t\t\tmargin: -1px;\n\t\t\tbox-shadow: 0 0 5px #ddd;\n\t\t\tbackground-color: #ffffff;\n\t\t}',
"\t\t@media (max-width: "+a.match(/--width:([^;]*)/)[1]+") {","\t\t\thtml {\n\t\t\t\tpadding: 0;\n\t\t\t\twidth: auto;\n\t\t\t}\n\t\t\tbody {\n\t\t\t\tpadding: 10px;\n\t\t\t}\n\t\t}\n\t}\n\t@media print {\n\t\thtml {\n\t\t\twidth: calc(var(--width) - 2 * var(--margin));\n\t\t}\n\t\tbody {\n\t\t\tpadding: 0;\n\t\t}\n\t\t@page {","\t\t\tsize: "+a.match(/--width:([^;]*)/)[1]+" "+a.match(/--height:([^;]*)/)[1]+";","\t\t\tmargin: "+a.match(/--margin:([^;]*)/)[1]+";","\t\t}\n\t\t@supports (-moz-appearance: none) { /* Firefox */\n\t\t\t@page {",
"\t\t\t\tmargin: 0 "+a.match(/--margin:([^;]*)/)[1]+";","\t\t\t}\n\t\t\t.firetext_page_margin {\n\t\t\t\theight: var(--margin);\n\t\t\t}\n\t\t}\n\t\thr.page-break {\n\t\t\tbreak-before: page;\n\t\t\tpage-break-before: always;\n\t\t\tmargin: 0;\n\t\t}\n\t}\n\t</style>\n\t\x3c!--_firetext_import_remove_end--\x3e</head>"].join("\n")).replace(/<body[^>]*>/,'$&\x3c!--_firetext_import_remove_start--\x3e\n<table style="border-collapse: collapse; table-layout: fixed; width: 100%;">\n\t<thead>\n\t\t<tr class="firetext_page_margin"><td style="padding: 0;"></td></tr>\n\t</thead>\n\t<tbody>\n\t\t<tr>\n\t\t\t<td style="padding: 0;">\n\t\t\t\x3c!--_firetext_import_remove_end--\x3e').replace("</body>",
'\x3c!--_firetext_import_remove_start--\x3e\n\t\t\t</td>\n\t\t</tr>\n\t</tbody>\n\t<tfoot>\n\t\t<tr class="firetext_page_margin"><td style="padding: 0;"></td></tr>\n\t</tfoot>\n</table>\n\x3c!--_firetext_import_remove_end--\x3e</body>');/<meta[^>]+charset/.test(a)||(a=a.replace("<head>",'<head><meta charset="utf-8">'));return a}var l,t,m,n;g.registerMessageHandler(function(a){var b,d,h="utf8String";switch(m){case ".html":b=r();d="text/html";break;case ".txt":b=c.body.innerText;d="text/plain";break;
case ".odt":n||l.setHTML(p());b=l.getODT({type:"arraybuffer"});d="application/vnd.oasis.opendocument.text";h="arrayBuffer";break;default:b=c.body.innerText}g.postMessage({command:a.data.key,content:b,codec:h,type:d})},"get-content-blob");g.registerMessageHandler(function(a){g.postMessage({command:a.data.key,content:r()})},"get-content-html");g.registerMessageHandler(function(a){var b=a.data.content,d=a.data.filename,h=a.data.filetype,v=a.data.user_location,e=a.data.readOnly,q=!1;c.documentElement.hasAttribute("_firetext_night")&&
(q=!0);t=d;m=h;n=e;c.open("text/html","replace");switch(m){case ".txt":b=firetext.parsers.plain.parse(b,"HTML");c.write(b);break;case ".odt":l=new ODTDocument(b);b=l.getHTMLUnsafe();try{b=l.getHTML()}catch(p){n=!0}c.write(b);break;default:b=b.replace(/\x3c!--_firetext_import_remove_start--\x3e[\s\S]*?\x3c!--_firetext_import_remove_end--\x3e/g,""),/<!DOCTYPE/i.test(b)||(b="<!DOCTYPE html>"+b),c.write(b)}c.close();q&&nightEditor(!0);u(m,v,l,n);a.data.key&&g.postMessage({command:a.data.key})},"load");
g.registerMessageHandler(function(a){var b=a.data.commands,d={},h,l;-1!==b.indexOf("justifyCenter")&&(h=window.getSelectedFrame())&&(l="left"===h.style.float?"justifyLeft":"right"===h.style.float?"justifyRight":"auto"===h.style.marginLeft?"justifyCenter":"justifyFull");var e=c.getSelection(),q=!1;if(/[^ ] $/.test(e)&&(!window.mousePressed||!navigator.userAgent.includes("Chrome"))&&e.setBaseAndExtent&&e.modify){var m=e.anchorNode,n=e.anchorOffset,p=e.focusNode,r=e.focusOffset,k=e.getRangeAt(0);e.setBaseAndExtent(k.startContainer,
k.startOffset,k.endContainer,k.endOffset);e.modify("extend","backward","character");q=!0}for(var f=0;f<b.length;f++)d[b[f]]={},h&&"justify"===b[f].substr(0,7)?d[b[f]].state=b[f]===l:"createLink"===b[f]?(k=e.getRangeAt(0),k=k.commonAncestorContainer.closest("a"),d[b[f]].state=!!k,d[b[f]].value=k&&k.href):(d[b[f]].state=c.queryCommandState(b[f]),d[b[f]].value=c.queryCommandValue(b[f]));q&&e.setBaseAndExtent(m,n,p,r);g.postMessage({command:a.data.key,commandStates:d})},"query-command-states");g.registerMessageHandler(function(a){var b=
{};a.data.properties.forEach(function(a){b[a]=c.documentElement.style.getPropertyValue("--"+a).replace(/\s+/g,"")});g.postMessage({command:a.data.key,propertyValues:b})},"get-properties");g.registerMessageHandler(function(a){Object.keys(a.data.properties).forEach(function(b){c.documentElement.style.setProperty("--"+b,a.data.properties[b])});c.dispatchEvent(new CustomEvent("input",{detail:"fromProperties"}))},"set-properties")};
